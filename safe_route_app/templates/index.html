<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <meta name="theme-color" content="#FF6B35">
    <title>RouteGuard - Your Safety Navigator</title>

    <!-- Leaflet CSS  -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

    <!-- Google Fonts - Optimized for Mobile -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/style.css?v=2026.1">
    <link rel="stylesheet" href="/static/css/professional_override.css?v=2026.1">
    <link rel="stylesheet" href="/static/css/sos_styles.css?v=2026.1">
    <style>
        /* Mobile elements hidden by default */
        .mobile-only {
            display: none !important;
        }

        /* Mobile View: Show mobile elements, hide desktop elements */
        @media (max-width: 768px) {
            .mobile-only {
                display: flex !important;
            }

            .desktop-only {
                display: none !important;
            }
        }
    </style>
</head>

<body>
    <!-- Desktop Header -->
    <header class="header desktop-only">
        <div class="header-content">
            <div class="logo">
                <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                    <path d="M16 2L4 10v12c0 7.18 5.82 13 13 13s13-5.82 13-13V10L16 2z" fill="url(#hinduGradient)"
                        stroke="#FF9933" stroke-width="2" />
                    <defs>
                        <linearGradient id="hinduGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#FF9933;stop-opacity:1" />
                            <stop offset="50%" style="stop-color:#FF6B35;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#1E3A8A;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                </svg>
                <h1>RouteGuard</h1>
            </div>
            <div class="header-stats">
                <div class="stat" id="news-bell" onclick="toggleNewsPanel()">
                    <span>üîî</span>
                    <span id="news-badge" style="display: none;"></span>
                </div>
                <div class="stat">
                    <span class="stat-value">{{ crime_count }}</span>
                    <span class="stat-label">Points</span>
                </div>
                <!-- ... other stats ... -->
                <div class="auth-controls">
                    <span id="user-email" style="color: #94a3b8; margin-right: 12px; display: none;"></span>
                    <button id="logout-btn" class="btn-secondary" onclick="logoutUser()">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Mobile Top Bar -->
    <div class="mobile-top-bar mobile-only">
        <div class="glass-search">
            <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
            <input type="text" id="mobile-search-input" placeholder="Search for destination..."
                onkeypress="handleMobileSearch(event)">
            <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
            </svg>
        </div>
        <div class="stats-chips">
            <div class="stat-chip">{{ crime_count }} Crime Hotspots</div>
            <div class="stat-chip">{{ safety_zone_count }} Safe Zones</div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Desktop Sidebar -->
        <aside class="sidebar desktop-only">
            <div class="sidebar-content">
                <div class="sidebar-section">
                    <h3>üîç Search Location</h3>
                    <div class="input-group">
                        <input type="text" id="location-search" placeholder="Search city..." class="search-input">
                        <button id="search-button" class="btn-primary" style="margin-top: 8px;">Search</button>
                    </div>
                </div>

                <div class="sidebar-section">
                    <h3>üó∫Ô∏è Plan Your Route</h3>
                    <div class="input-group">
                        <label>üìç Start</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="start-location" placeholder="Origin" style="flex: 1;">
                            <button id="search-start-btn" class="btn-secondary" style="padding: 8px;">üîç</button>
                        </div>
                        <button id="use-current-location" class="btn-secondary"
                            style="margin-top: 8px; width: 100%;">Use My Location</button>
                    </div>
                    <div class="input-group">
                        <label>üéØ Destination</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="end-location" placeholder="Destination" style="flex: 1;">
                            <button id="search-dest-btn" class="btn-secondary" style="padding: 8px;">üîç</button>
                        </div>
                    </div>
                    <button id="calculate-route" class="btn-primary" disabled>Find Safest Route</button>
                    <button id="clear-route" class="btn-secondary" style="margin-top: 8px;">Clear</button>
                </div>

                <!-- Desktop Route Results -->
                <div class="sidebar-section" id="route-results" style="display: none;">
                    <h3>üõ£Ô∏è Route Options</h3>
                    <div id="routes-container"></div>
                </div>

                <div class="sidebar-section">
                    <h3>‚öôÔ∏è Options</h3>
                    <button id="generate-sample-data" class="btn-secondary">Generate Data</button>
                    <label for="csv-upload" class="btn-secondary"
                        style="margin-top: 8px; cursor: pointer; text-align: center; display: block;">
                        Upload Crime CSV
                    </label>
                    <input type="file" id="csv-upload" accept=".csv" style="display: none;">
                </div>
            </div>
        </aside>

        <!-- Map -->
        <main class="map-container">
            <div id="map"></div>
            <!-- Loading Overlay -->
            <div id="loading-overlay" class="loading-overlay" style="display: none;">
                <div class="spinner"></div>
                <p style="color: #f1f5f9;">Calculating safest routes...</p>
            </div>
        </main>
    </div>

    <!-- Mobile Bottom Sheet -->
    <div class="mobile-bottom-sheet mobile-only">
        <div class="sheet-handle"></div>
        <h2 class="sheet-title">üõ°Ô∏è Plan Your Safe Journey</h2>

        <div class="sheet-input-group">
            <div class="sheet-input-row">
                <div class="sheet-icon">üìç</div>
                <input type="text" id="mobile-start-location" placeholder="Search start location..." 
                    oninput="handleMobileLocationSearch(this, 'start')" 
                    onfocus="showLocationSuggestions(this, 'start')">
                <button class="icon-btn" onclick="useCurrentLocationMobile()" title="Use Current Location">
                    <svg width="16" height="16" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd"
                            d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"
                            clip-rule="evenodd" />
                    </svg>
                </button>
            </div>
            <div class="sheet-input-row">
                <div class="sheet-icon">üéØ</div>
                <input type="text" id="mobile-end-location" placeholder="Search destination..." 
                    oninput="handleMobileLocationSearch(this, 'end')" 
                    onfocus="showLocationSuggestions(this, 'end')">
                <button class="icon-btn" onclick="clearDestinationMobile()" title="Clear Destination">
                    <svg width="16" height="16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="mobile-suggestions" id="mobile-suggestions" style="display: none;"></div>
        </div>

        <button class="sheet-primary-btn" onclick="triggerRouteCalculation()" id="mobile-calculate-btn" disabled>
            <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" style="margin-right: 8px;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
            </svg>
            Find Safest Route
        </button>

        <!-- Map Selection Mode Toggle -->
        <div class="map-selection-toggle">
            <button class="map-select-btn" id="map-select-btn" onclick="toggleMapSelectionMode()">
                üìç Tap Map to Select
            </button>
            <div class="selection-mode-info" id="selection-mode-info" style="display: none;">
                <span class="selection-text">üìç Tap map to set <span id="selection-type">start</span> point</span>
                <button class="cancel-selection" onclick="cancelMapSelection()">Cancel</button>
            </div>
        </div>

        <div class="sheet-actions">
            <div class="text-muted" style="font-size: 0.8rem; color: var(--text-muted);">
                üåü All features available ‚Ä¢ Swipe up for options
            </div>
            <button class="icon-btn" onclick="showMobilePanel('options')" title="More Options">
                <svg width="20" height="20" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />
                </svg>
            </button>
        </div>
    </div>

    <!-- SOS Button (Fixed Position) -->
    <div class="sos-wrapper" style="position: fixed; z-index: 1000;">
        <button class="sos-button" id="sos-trigger" title="Emergency SOS">
            <span class="sos-icon">üÜò</span>
        </button>
    </div>

    <!-- Modals & Overlays -->
    <!-- Recording Indicator -->
    <div id="recording-indicator" class="recording-indicator">
        <div class="recording-dot"></div>
        <span>Recording Evidence: <span id="recording-time">00:00</span></span>
    </div>

    <div class="sos-countdown-modal" id="sos-countdown">
        <div class="countdown-content">
            <div class="countdown-number" id="countdown-number">3</div>
            <p class="countdown-text">Alerting Police...</p>
            <button class="cancel-sos-btn" id="cancel-sos">Cancel</button>
        </div>
    </div>

    <div class="police-notified-screen" id="police-notified">
        <div class="notified-header" style="width: 100%; display: flex; justify-content: flex-end; padding: 20px;">
            <button onclick="minimizeSOS()" class="btn-icon"
                style="background: rgba(255,255,255,0.1); border: none; color: white; padding: 8px; border-radius: 50%; cursor: pointer;">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
        </div>
        <div class="notified-content" style="text-align: center; margin-top: -40px;">
            <div class="notified-icon">‚úÖ</div>
            <h2 class="notified-title">Police Notified</h2>
            <p class="notified-message" style="margin: 10px 0; font-size: 0.95rem; line-height: 1.4; color: #cbd5e1;">
            </p>
            <div class="notified-details">
                <p><strong>Officer:</strong> <span id="officer-name-display">Connecting...</span></p>
                <p><strong>Status:</strong> <span id="alert-status">Active</span></p>
            </div>
            <button class="end-sos-btn" id="end-sos">End Emergency</button>
        </div>
    </div>

    <!-- Minimized SOS Status -->
    <div id="sos-minimized-bar" onclick="maximizeSOS()"
        style="display: none; position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); background: #ef4444; color: white; padding: 12px 24px; border-radius: 30px; box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4); z-index: 2000; align-items: center; gap: 10px; cursor: pointer; animation: pulse-red 2s infinite;">
        <span style="font-weight: 600;">‚ö†Ô∏è SOS Active</span>
        <span style="font-size: 0.9em; opacity: 0.9;">‚Ä¢ Tap to Expand</span>
    </div>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav mobile-only">
        <div class="mobile-nav-items">
            <div class="mobile-nav-item active" onclick="showMobilePanel('route')">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-1.447-.894L15 4m0 13V4m0 0L9 7" />
                </svg>
                <span>Route</span>
            </div>
            <div class="mobile-nav-item" onclick="showMobilePanel('options')">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4" />
                </svg>
                <span>Options</span>
            </div>
            <div class="mobile-nav-item" onclick="showMobilePanel('results')">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                <span>Results</span>
            </div>
            <div class="mobile-nav-item" onclick="showMobilePanel('safety')">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                </svg>
                <span>Safety</span>
            </div>
            <div class="mobile-nav-item" onclick="showMobilePanel('profile')">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
                <span>Profile</span>
            </div>
        </div>
    </nav>

    <!-- Mobile Route Results Panel -->
    <div class="mobile-route-panel mobile-only" id="mobile-route-panel">
        <div class="mobile-route-header">
            <h3 class="mobile-route-title">üõ£Ô∏è Route Options</h3>
            <button class="mobile-close-btn" onclick="closeMobilePanel('route')">&times;</button>
        </div>
        <div id="mobile-routes-container"></div>
    </div>

    <!-- Mobile Options Panel -->
    <div class="mobile-options-panel mobile-only" id="mobile-options-panel">
        <div class="mobile-route-header">
            <h3 class="mobile-route-title">‚öôÔ∏è Options</h3>
            <button class="mobile-close-btn" onclick="closeMobilePanel('options')">&times;</button>
        </div>
        <div class="mobile-option-item" onclick="generateSampleDataMobile()">
            <svg class="mobile-option-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
            </svg>
            <span class="mobile-option-text">Generate Sample Data</span>
        </div>
        <div class="mobile-option-item" onclick="triggerCSVUploadMobile()">
            <svg class="mobile-option-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
            </svg>
            <span class="mobile-option-text">Upload Crime CSV</span>
        </div>
        <div class="mobile-option-item" onclick="clearAllDataMobile()">
            <svg class="mobile-option-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            <span class="mobile-option-text">Clear All Routes</span>
        </div>
    </div>

    <!-- Mobile Profile Panel -->
    <div class="mobile-options-panel mobile-only" id="mobile-profile-panel">
        <div class="mobile-route-header">
            <h3 class="mobile-route-title">üë§ Profile</h3>
            <button class="mobile-close-btn" onclick="closeMobilePanel('profile')">&times;</button>
        </div>
        <div class="mobile-profile-content">
            <div class="mobile-user-info" id="mobile-user-info" style="display: none;">
                <div class="user-avatar">
                    <svg width="48" height="48" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                </div>
                <div class="user-details">
                    <div class="user-email" id="mobile-user-email">Not logged in</div>
                    <div class="user-status">RouteGuard User</div>
                </div>
            </div>
            <div class="mobile-option-item" onclick="logoutUser()">
                <svg class="mobile-option-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                </svg>
                <span class="mobile-option-text">Logout</span>
            </div>
            <div class="mobile-option-item" onclick="showAppInfo()">
                <svg class="mobile-option-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="mobile-option-text">About RouteGuard</span>
            </div>
        </div>
    </div>

    <!-- News Panel Overlay -->
    <div id="news-panel"
        style="position: fixed; top: 70px; right: -400px; width: 350px; background: #1e293b; bottom: 20px; z-index: 3000; border-radius: 12px 0 0 12px; box-shadow: -4px 0 20px rgba(0,0,0,0.5); transition: right 0.3s ease; padding: 20px; overflow-y: auto; border-left: 1px solid #334155;">
        <div
            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #334155; padding-bottom: 10px;">
            <h3 style="color: white; margin: 0;">üì¢ Safety Updates</h3>
            <button onclick="toggleNewsPanel()"
                style="background: none; border: none; color: #94a3b8; cursor: pointer; font-size: 1.25rem;">‚úï</button>
        </div>
        <div id="news-feed-content">
            <p style="color: #94a3b8; text-align: center;">Loading updates...</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-storage-compat.js"></script>
    {{ firebase_config|json_script:"firebase-config-data" }}
    <script>
        const firebaseConfig = JSON.parse(document.getElementById('firebase-config-data').textContent);
        if (typeof firebase !== 'undefined' && !firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
    </script>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

    <script src="/static/js/main.js"></script>
    <script src="/static/js/sos_handler.js"></script>
    <script src="/static/js/live_tracker.js"></script>

    <script>
        // Mobile Interactions Glue Code
        function handleMobileSearch(e) {
            if (e.key === 'Enter') {
                const query = e.target.value;
                // Reuse existing search logic by injecting into the main search input and clicking button
                const mainInput = document.getElementById('location-search');
                const mainBtn = document.getElementById('search-button');
                if (mainInput && mainBtn) {
                    mainInput.value = query;
                    mainBtn.click();
                    // Also scroll map into view if needed
                }
            }
        }

        function useCurrentLocationMobile() {
            // Trigger the desktop button
            document.getElementById('use-current-location').click();
        }

        function triggerRouteCalculation() {
            document.getElementById('calculate-route').click();
        }

        // Sync Desktop inputs to Mobile inputs (Observer pattern or simple polling/event)
        const desktopStart = document.getElementById('start-location');
        const desktopEnd = document.getElementById('end-location');
        const mobileStart = document.getElementById('mobile-start-location');
        const mobileEnd = document.getElementById('mobile-end-location');

        function syncInputs() {
            if (mobileStart && desktopStart) mobileStart.value = desktopStart.value;
            if (mobileEnd && desktopEnd) mobileEnd.value = desktopEnd.value;
        }

        // Observer to watch for value changes on desktop inputs (which are set by map clicks)
        setInterval(syncInputs, 500); // Polling is simplest and robust for this temp glue code

        // Mobile Panel Management
        let activeMobilePanel = null;

        function showMobilePanel(panelType) {
            // Close any open panel first
            if (activeMobilePanel) {
                closeMobilePanel(activeMobilePanel);
            }

            // Update navigation active state
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[onclick="showMobilePanel('${panelType}')"]`).classList.add('active');

            // Show the requested panel
            const panelId = `mobile-${panelType}-panel`;
            const panel = document.getElementById(panelId);
            if (panel) {
                panel.style.display = 'block';
                panel.classList.add('show');
                setTimeout(() => panel.style.opacity = '1', 10);
                activeMobilePanel = panelType;
            }

            // Special handling for results panel
            if (panelType === 'results') {
                syncRouteResults();
            }
        }

        function closeMobilePanel(panelType) {
            const panelId = `mobile-${panelType}-panel`;
            const panel = document.getElementById(panelId);
            if (panel) {
                panel.classList.remove('show');
                panel.style.opacity = '0';
                setTimeout(() => panel.style.display = 'none', 300);
            }
            activeMobilePanel = null;

            // Reset navigation to route tab
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`[onclick="showMobilePanel('route')"]`).classList.add('active');
        }

        function syncRouteResults() {
            const desktopContainer = document.getElementById('routes-container');
            const mobileContainer = document.getElementById('mobile-routes-container');
            if (desktopContainer && mobileContainer) {
                mobileContainer.innerHTML = desktopContainer.innerHTML;
            }
        }

        function generateSampleDataMobile() {
            document.getElementById('generate-sample-data').click();
            showToast('Generating sample crime data...', 'info');
            closeMobilePanel('options');
        }

        function triggerCSVUploadMobile() {
            document.getElementById('csv-upload').click();
            closeMobilePanel('options');
        }

        function clearAllDataMobile() {
            if (confirm('Clear all routes and data?')) {
                document.getElementById('clear-route').click();
                showToast('Routes cleared', 'success');
            }
            closeMobilePanel('options');
        }

        // Mobile Location Search Functions
        let searchTimeout = null;
        let currentSearchType = null;

        function handleMobileLocationSearch(input, type) {
            clearTimeout(searchTimeout);
            const query = input.value.trim();
            
            if (query.length < 2) {
                hideMobileSuggestions();
                return;
            }

            searchTimeout = setTimeout(() => {
                searchLocations(query, type);
            }, 300);
        }

        function showLocationSuggestions(input, type) {
            currentSearchType = type;
            const suggestionsDiv = document.getElementById('mobile-suggestions');
            
            if (input.value.trim().length === 0) {
                showQuickLocations(type);
            }
        }

        function showQuickLocations(type) {
            const suggestionsDiv = document.getElementById('mobile-suggestions');
            const quickLocations = [
                { icon: 'üè†', name: 'Home', desc: 'Your home location' },
                { icon: 'üíº', name: 'Work', desc: 'Your workplace' },
                { icon: 'üè•', name: 'Hospital', desc: 'Nearest hospital' },
                { icon: 'üöî', name: 'Police Station', desc: 'Nearest police station' },
                { icon: 'üè™', name: 'Market', desc: 'Local market area' }
            ];

            let html = '<div class="quick-locations">';
            quickLocations.forEach(loc => {
                html += `<button class="quick-location-btn" onclick="selectQuickLocation('${loc.name}', '${type}')">
                    ${loc.icon} ${loc.name}
                </button>`;
            });
            html += '</div>';

            suggestionsDiv.innerHTML = html;
            suggestionsDiv.style.display = 'block';
        }

        function searchLocations(query, type) {
            // Use Nominatim API for location search
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5&addressdetails=1`;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    showSearchResults(data, type);
                })
                .catch(error => {
                    console.error('Search error:', error);
                    showToast('Search failed. Try again.', 'error');
                });
        }

        function showSearchResults(results, type) {
            const suggestionsDiv = document.getElementById('mobile-suggestions');
            
            if (results.length === 0) {
                suggestionsDiv.innerHTML = '<div class="suggestion-item"><span class="suggestion-text">No results found</span></div>';
                suggestionsDiv.style.display = 'block';
                return;
            }

            let html = '';
            results.forEach(result => {
                const mainText = result.display_name.split(',')[0];
                const subText = result.display_name.split(',').slice(1, 3).join(',');
                
                html += `
                    <div class="suggestion-item" onclick="selectLocation('${result.lat}', '${result.lon}', '${mainText.replace(/'/g, "\\'")}, ${subText.replace(/'/g, "\\'")}'.substring(0, 50), '${type}')">
                        <span class="suggestion-icon">üìç</span>
                        <div class="suggestion-text">
                            <div class="suggestion-main">${mainText}</div>
                            <div class="suggestion-sub">${subText}</div>
                        </div>
                    </div>
                `;
            });

            suggestionsDiv.innerHTML = html;
            suggestionsDiv.style.display = 'block';
        }

        function selectLocation(lat, lon, name, type) {
            const input = document.getElementById(`mobile-${type}-location`);
            const desktopInput = document.getElementById(`${type}-location`);
            
            input.value = name;
            if (desktopInput) desktopInput.value = name;

            // Add marker to map
            const latLng = [parseFloat(lat), parseFloat(lon)];
            
            if (type === 'start') {
                if (window.startMarker) map.removeLayer(window.startMarker);
                window.startMarker = L.marker(latLng, {
                    icon: L.divIcon({
                        className: 'custom-marker start-marker',
                        html: 'üö©',
                        iconSize: [30, 30]
                    })
                }).addTo(map);
                window.startPoint = latLng;
            } else {
                if (window.destinationMarker) map.removeLayer(window.destinationMarker);
                window.destinationMarker = L.marker(latLng, {
                    icon: L.divIcon({
                        className: 'custom-marker end-marker',
                        html: 'üéØ',
                        iconSize: [30, 30]
                    })
                }).addTo(map);
                window.endPoint = latLng;
            }

            map.setView(latLng, 15);
            hideMobileSuggestions();
            updateMobileCalculateButton();
            
            // Enable desktop calculate button
            const desktopCalcBtn = document.getElementById('calculate-route');
            if (desktopCalcBtn && window.startPoint && window.endPoint) {
                desktopCalcBtn.disabled = false;
            }
            
            showToast(`${type === 'start' ? 'Start' : 'Destination'} set: ${name}`, 'success');
        }

        function selectQuickLocation(name, type) {
            const input = document.getElementById(`mobile-${type}-location`);
            input.value = name;
            input.focus();
            
            // Trigger search for the quick location
            handleMobileLocationSearch(input, type);
            showToast(`Searching for ${name}...`, 'info');
        }

        function hideMobileSuggestions() {
            const suggestionsDiv = document.getElementById('mobile-suggestions');
            suggestionsDiv.style.display = 'none';
        }

        // Hide suggestions when clicking outside
        document.addEventListener('click', function(e) {
            const suggestionsDiv = document.getElementById('mobile-suggestions');
            const inputStart = document.getElementById('mobile-start-location');
            const inputEnd = document.getElementById('mobile-end-location');
            
            if (!suggestionsDiv.contains(e.target) && 
                e.target !== inputStart && 
                e.target !== inputEnd) {
                hideMobileSuggestions();
            }
        });

        // Mobile-specific toast positioning
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
                toast.style.position = 'fixed';
                toast.style.top = '140px';
                toast.style.left = '20px';
                toast.style.right = '20px';
                toast.style.width = 'auto';
                toast.style.minWidth = 'auto';
            }

            toast.innerHTML = `
                <div class="toast-message">${message}</div>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(400px)';
                setTimeout(() => container.removeChild(toast), 300);
            }, 3000);
        }

        function updateMobileCalculateButton() {
            const startInput = document.getElementById('mobile-start-location');
            const endInput = document.getElementById('mobile-end-location');
            const calcBtn = document.getElementById('mobile-calculate-btn');
            
            if (calcBtn && startInput && endInput) {
                const hasStart = startInput.value.trim() !== '';
                const hasEnd = endInput.value.trim() !== '';
                calcBtn.disabled = !(hasStart && hasEnd);
                
                if (hasStart && hasEnd) {
                    calcBtn.style.opacity = '1';
                    calcBtn.innerHTML = 'üîç Find Safest Route';
                } else {
                    calcBtn.style.opacity = '0.6';
                    calcBtn.innerHTML = hasStart ? 'üéØ Set destination on map' : 'üìç Set start location first';
                }
            }
        }

        function clearDestinationMobile() {
            const mobileEnd = document.getElementById('mobile-end-location');
            const desktopEnd = document.getElementById('end-location');
            if (mobileEnd) mobileEnd.value = '';
            if (desktopEnd) desktopEnd.value = '';
            
            // Clear destination marker if exists
            if (window.destinationMarker) {
                map.removeLayer(window.destinationMarker);
                window.destinationMarker = null;
            }
            
            updateMobileCalculateButton();
            showToast('Destination cleared', 'info');
        }

        // Map Selection Mode
        let mapSelectionMode = false;
        let selectionType = 'start'; // 'start' or 'end'

        function toggleMapSelectionMode() {
            mapSelectionMode = !mapSelectionMode;
            const btn = document.getElementById('map-select-btn');
            const info = document.getElementById('selection-mode-info');
            const bottomSheet = document.querySelector('.mobile-bottom-sheet');

            if (mapSelectionMode) {
                btn.style.display = 'none';
                info.style.display = 'flex';
                
                // Minimize bottom sheet
                bottomSheet.style.transform = 'translateY(80%)';
                bottomSheet.style.transition = 'transform 0.3s ease';
                
                // Determine what to select next
                const startInput = document.getElementById('mobile-start-location');
                const endInput = document.getElementById('mobile-end-location');
                
                if (!startInput.value.trim()) {
                    selectionType = 'start';
                } else if (!endInput.value.trim()) {
                    selectionType = 'end';
                } else {
                    selectionType = 'start';
                }
                
                document.getElementById('selection-type').textContent = selectionType;
                showToast(`Tap anywhere on map to set ${selectionType} point`, 'info');
            } else {
                cancelMapSelection();
            }
        }

        function cancelMapSelection() {
            mapSelectionMode = false;
            const btn = document.getElementById('map-select-btn');
            const info = document.getElementById('selection-mode-info');
            const bottomSheet = document.querySelector('.mobile-bottom-sheet');
            
            btn.style.display = 'block';
            info.style.display = 'none';
            
            // Restore bottom sheet
            bottomSheet.style.transform = 'translateY(0)';
            
            document.body.classList.remove('map-selection-active');
        }

        // Enhanced map click handler
        function handleMapClick(e) {
            if (!mapSelectionMode) return;
            
            const lat = e.latlng.lat;
            const lon = e.latlng.lng;
            
            // Reverse geocode to get address
            fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                .then(response => response.json())
                .then(data => {
                    const address = data.display_name ? 
                        data.display_name.split(',').slice(0, 3).join(',') : 
                        `Location (${lat.toFixed(4)}, ${lon.toFixed(4)})`;
                    
                    selectLocation(lat, lon, address, selectionType);
                    
                    // Auto-switch to destination if start was just set
                    if (selectionType === 'start') {
                        const endInput = document.getElementById('mobile-end-location');
                        if (!endInput.value.trim()) {
                            selectionType = 'end';
                            document.getElementById('selection-type').textContent = 'destination';
                            showToast('Now tap map to set destination', 'info');
                            return; // Keep selection mode active
                        }
                    }
                    
                    // Exit selection mode
                    cancelMapSelection();
                })
                .catch(() => {
                    const address = `Location (${lat.toFixed(4)}, ${lon.toFixed(4)})`;
                    selectLocation(lat, lon, address, selectionType);
                    cancelMapSelection();
                });
        }

        // Enhanced route calculation with mobile display
        function triggerRouteCalculation() {
            const startInput = document.getElementById('mobile-start-location');
            const endInput = document.getElementById('mobile-end-location');
            
            if (!startInput.value.trim() || !endInput.value.trim()) {
                showToast('Please set both start and destination points', 'warning');
                return;
            }
            
            if (!window.startPoint || !window.endPoint) {
                showToast('Please select locations on map or from search', 'warning');
                return;
            }
            
            // Trigger desktop route calculation
            const desktopBtn = document.getElementById('calculate-route');
            if (desktopBtn) {
                desktopBtn.disabled = false;
                desktopBtn.click();
                
                // Show loading and then results
                showToast('Calculating safest routes...', 'info');
                
                setTimeout(() => {
                    showMobilePanel('results');
                    syncRouteResults();
                }, 2000);
            } else {
                showToast('Route calculation unavailable', 'error');
            }
        }

        // Enhanced route results sync
        function syncRouteResults() {
            const desktopContainer = document.getElementById('routes-container');
            const mobileContainer = document.getElementById('mobile-routes-container');
            
            if (desktopContainer && mobileContainer) {
                const desktopCards = desktopContainer.querySelectorAll('.route-card');
                let mobileHTML = '';
                
                desktopCards.forEach((card, index) => {
                    const title = card.querySelector('.route-title')?.textContent || `Route ${index + 1}`;
                    const score = card.querySelector('.route-score')?.textContent || 'N/A';
                    const badge = card.querySelector('.route-badge')?.textContent || '';
                    const details = card.querySelectorAll('.detail-item');
                    
                    let detailsHTML = '';
                    details.forEach(detail => {
                        const label = detail.textContent.split(':')[0];
                        const value = detail.querySelector('.detail-value')?.textContent || detail.textContent.split(':')[1];
                        detailsHTML += `
                            <div class="mobile-detail-item">
                                ${label}: <span class="mobile-detail-value">${value}</span>
                            </div>
                        `;
                    });
                    
                    const isRecommended = card.classList.contains('recommended');
                    
                    mobileHTML += `
                        <div class="mobile-route-card ${isRecommended ? 'recommended' : ''}" onclick="selectMobileRoute(${index})">
                            <div class="mobile-route-header">
                                <span class="mobile-route-title">${title} ${badge ? `‚Ä¢ ${badge}` : ''}</span>
                                <span class="mobile-route-score">${score}</span>
                            </div>
                            <div class="mobile-route-details">
                                ${detailsHTML}
                            </div>
                        </div>
                    `;
                });
                
                mobileContainer.innerHTML = mobileHTML || '<div style="text-align: center; color: var(--text-muted); padding: 20px;">No routes found. Try different locations.</div>';
            }
        }

        function selectMobileRoute(index) {
            const desktopCards = document.querySelectorAll('.route-card');
            if (desktopCards[index]) {
                desktopCards[index].click();
                showToast('Route selected on map', 'success');
                closeMobilePanel('results');
            }
        }

        // Enhanced sync function with mobile button updates
        function syncInputs() {
            if (mobileStart && desktopStart) mobileStart.value = desktopStart.value;
            if (mobileEnd && desktopEnd) mobileEnd.value = desktopEnd.value;
            updateMobileCalculateButton();
        }
            const container = document.getElementById('toast-container');
            if (!container) return;

            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const isMobile = window.innerWidth <= 768;
            if (isMobile) {
                toast.style.position = 'fixed';
                toast.style.top = '140px';
                toast.style.left = '20px';
                toast.style.right = '20px';
                toast.style.width = 'auto';
                toast.style.minWidth = 'auto';
            }

            toast.innerHTML = `
                <div class="toast-message">${message}</div>
            `;

            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(400px)';
                setTimeout(() => container.removeChild(toast), 300);
            }, 3000);
        }

        function useCurrentLocationMobile() {
            if (navigator.geolocation) {
                showToast('Getting your location...', 'info');
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        const lat = position.coords.latitude;
                        const lon = position.coords.longitude;
                        
                        // Reverse geocode to get address
                        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`)
                            .then(response => response.json())
                            .then(data => {
                                const address = data.display_name.split(',').slice(0, 3).join(',');
                                selectLocation(lat, lon, address, 'start');
                            })
                            .catch(() => {
                                selectLocation(lat, lon, `Current Location (${lat.toFixed(4)}, ${lon.toFixed(4)})`, 'start');
                            });
                    },
                    function(error) {
                        showToast('Location access denied', 'error');
                    },
                    { enableHighAccuracy: true, timeout: 10000 }
                );
            } else {
                showToast('Geolocation not supported', 'error');
            }
        }

        function showAppInfo() {
            showToast('RouteGuard v1.0 - Your Safety Navigator', 'info');
            closeMobilePanel('profile');
        }

        // Update mobile user info
        function updateMobileUserInfo(user) {
            const userInfo = document.getElementById('mobile-user-info');
            const userEmail = document.getElementById('mobile-user-email');
            
            if (user && userEmail) {
                userEmail.textContent = user.email;
                userInfo.style.display = 'flex';
            } else {
                userInfo.style.display = 'none';
            }
        }
            // Set initial mobile panel styles
            const panels = ['mobile-route-panel', 'mobile-options-panel'];
            panels.forEach(panelId => {
                const panel = document.getElementById(panelId);
                if (panel) {
                    panel.style.display = 'none';
                    panel.style.opacity = '0';
                    panel.style.transition = 'opacity 0.3s ease';
                }
            });

            // Update mobile button state on load
            updateMobileCalculateButton();
            
            // Initialize map click handler when map is ready
            setTimeout(() => {
                if (typeof map !== 'undefined') {
                    map.on('click', handleMapClick);
                }
        // Initialize mobile features
        document.addEventListener('DOMContentLoaded', function() {
            // Set initial mobile panel styles
            const panels = ['mobile-route-panel', 'mobile-options-panel', 'mobile-profile-panel'];
            panels.forEach(panelId => {
                const panel = document.getElementById(panelId);
                if (panel) {
                    panel.style.display = 'none';
                    panel.style.opacity = '0';
                    panel.style.transition = 'opacity 0.3s ease';
                }
            });

            // Update mobile button state on load
            updateMobileCalculateButton();
            
            // Initialize map click handler when map is ready
            setTimeout(() => {
                if (typeof map !== 'undefined') {
                    map.on('click', handleMapClick);
                }
            }, 1000);
            
            // Fix mobile navigation clicks
            document.querySelectorAll('.mobile-nav-item').forEach(item => {
                item.addEventListener('touchstart', function(e) {
                    e.preventDefault();
                    this.click();
                });
            });
        });
        function minimizeSOS() {
            const policeScreen = document.getElementById('police-notified');
            const minimizedBar = document.getElementById('sos-minimized-bar');
            
            if (policeScreen) {
                policeScreen.style.display = 'none';
                policeScreen.classList.remove('active');
            }
            
            if (minimizedBar) {
                minimizedBar.style.display = 'flex';
            }
        }

        function maximizeSOS() {
            const policeScreen = document.getElementById('police-notified');
            const minimizedBar = document.getElementById('sos-minimized-bar');
            
            if (policeScreen) {
                policeScreen.style.display = 'flex';
                policeScreen.classList.add('active');
            }
            
            if (minimizedBar) {
                minimizedBar.style.display = 'none';
            }
        }

        async function logoutUser() {
            if (!confirm("Are you sure you want to logout?")) return;
            try {
                if (typeof firebase !== 'undefined' && firebase.auth().currentUser) {
                    await firebase.auth().signOut();
                }
                await fetch('/auth/logout/');
                window.location.reload();
            } catch (e) {
                console.error("Logout failed", e);
                window.location.reload();
            }
        }

        if (typeof firebase !== 'undefined') {
            firebase.auth().onAuthStateChanged((user) => {
                const emailSpan = document.getElementById('user-email');
                const logoutBtn = document.getElementById('logout-btn');

        // Update mobile user info
        function updateMobileUserInfo(user) {
            const userInfo = document.getElementById('mobile-user-info');
            const userEmail = document.getElementById('mobile-user-email');
            
            if (user && userEmail) {
                userEmail.textContent = user.email;
                userInfo.style.display = 'flex';
            } else {
                userInfo.style.display = 'none';
            }
        }

                if (user) {
                    if (emailSpan) {
                        emailSpan.textContent = user.email;
                        emailSpan.style.display = 'inline';
                    }
                    if (logoutBtn) logoutBtn.style.display = 'inline-block';
                    updateMobileUserInfo(user);
                } else {
                    if (emailSpan) emailSpan.style.display = 'none';
                    if (logoutBtn) logoutBtn.style.display = 'none';
                    updateMobileUserInfo(null);
                }
            });
        }
    </script>
</body>

</html>